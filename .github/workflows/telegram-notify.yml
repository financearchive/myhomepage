name: Smart Telegram Notification

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'src/site/notes/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v39
      with:
        files: |
          src/site/notes/**

    - name: Process and send notification
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        # ì˜¤ëŠ˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
        TODAY=$(date '+%Y-%m-%d')
        
        # ë³€ê²½ëœ íŒŒì¼ë“¤ ì²˜ë¦¬
        CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        for file in $CHANGED_FILES; do
          if [[ $file == *.md ]]; then
            echo "Processing file: $file"
            
            # íŒŒì¼ ì´ë¦„ ì¶”ì¶œ (í™•ì¥ì ì œê±°)
            filename=$(basename "$file" .md)
            
            # í´ë” ê²½ë¡œë¡œ ì¹´í…Œê³ ë¦¬ íŒë‹¨
            if [[ $file == *"0.DAILY Invest"* ]]; then
              # ì‹œí™© ë¶„ì„
              TITLE="ğŸ“Š ì˜¤ëŠ˜ì˜ ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ ì‹œí™©($filename)"
              EMOJI="ğŸ“ˆ"
              CATEGORY="ì‹œí™©ë¶„ì„"
              
            elif [[ $file == *"2.ê°œë³„ì¢…ëª©"* ]]; then
              # ê°œë³„ ì¢…ëª© ë¶„ì„
              TITLE="ğŸ” ê°œë³„ì¢…ëª© ë¶„ì„: $filename"
              EMOJI="ğŸ“Š"
              CATEGORY="ì¢…ëª©ë¶„ì„"
              
            elif [[ $file == *"1.Study"* ]]; then
              # ì‚°ì—… ë¶„ì„
              TITLE="ğŸ­ ì‚°ì—… ë¶„ì„: $filename"
              EMOJI="âš¡"
              CATEGORY="ì‚°ì—…ë¶„ì„"
              
            else
              # ê¸°íƒ€
              TITLE="ğŸ“ ìƒˆ ê¸€ ì—…ë°ì´íŠ¸: $filename"
              EMOJI="ğŸ“„"
              CATEGORY="ê¸°íƒ€"
            fi
            
            # íŒŒì¼ ë‚´ìš©ì—ì„œ ì‹¤ì œ ì œëª© ì¶”ì¶œ (# ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì²« ë²ˆì§¸ ì¤„)
            CONTENT_TITLE=$(head -20 "$file" | grep -E "^# " | head -1 | sed 's/^# //' | sed 's/ğŸ“Š //g' | sed 's/ğŸ” //g' | sed 's/ğŸ­ //g' || echo "")
            
            # íŒŒì¼ ë‚´ìš© ìš”ì•½ (ì²˜ìŒ 300ì, ë§ˆí¬ë‹¤ìš´ ì œê±°)
            CONTENT_SUMMARY=$(head -15 "$file" | grep -v "^#" | grep -v "^---" | grep -v "^$" | head -5 | tr '\n' ' ' | sed 's/\*\*//g' | sed 's/\*//g' | cut -c1-300)
            
            # ë©”ì‹œì§€ êµ¬ì„±
            MESSAGE="$EMOJI <b>$TITLE</b>
            
ğŸ”— <a href=\"https://moneydiary.co.kr\">moneydiary.co.kr</a>
            
ğŸ“‹ <b>ì¹´í…Œê³ ë¦¬</b>: $CATEGORY"
            
            # ì‹¤ì œ ì œëª©ì´ ìˆìœ¼ë©´ ì¶”ê°€
            if [[ -n "$CONTENT_TITLE" ]]; then
              MESSAGE="$MESSAGE
              
ğŸ“Œ <b>ì›ë¬¸ ì œëª©</b>: $CONTENT_TITLE"
            fi
            
            # ìš”ì•½ ë‚´ìš© ì¶”ê°€
            if [[ -n "$CONTENT_SUMMARY" ]]; then
              MESSAGE="$MESSAGE
              
ğŸ’­ <b>ë‚´ìš© ìš”ì•½</b>: 
${CONTENT_SUMMARY}..."
            fi
            
            MESSAGE="$MESSAGE
            
â° <i>ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S')</i>"
            
            # í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
                \"text\": \"$MESSAGE\",
                \"parse_mode\": \"HTML\",
                \"disable_web_page_preview\": false
              }"
            
            # ê° íŒŒì¼ë§ˆë‹¤ 1ì´ˆ ëŒ€ê¸° (ì—°ì† ì „ì†¡ ë°©ì§€)
            sleep 1
            
          fi
        done
