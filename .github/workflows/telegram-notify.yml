name: Smart Telegram Notification

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'src/site/notes/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v39
      with:
        files: |
          src/site/notes/**

    - name: Process and send notification
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        for file in $CHANGED_FILES; do
          if [[ $file == *.md ]]; then
            echo "Processing file: $file"
            
            if [[ $file == *"Home.md"* ]]; then
              echo "Skipping Home.md file"
              continue
            fi
            
            if [[ ! -f "$file" ]]; then
              echo "File not found: $file"
              continue
            fi
            
            filename=$(basename "$file" .md)
            
            if [[ $file == *"0.DAILY Invest"* ]]; then
              TITLE="üìä Ïò§ÎäòÏùò ÎØ∏Íµ≠ Ï£ºÏãù ÏãúÏû• ÏãúÌô©($filename)"
              EMOJI="üìà"
              CATEGORY="ÏãúÌô©Î∂ÑÏÑù"
            elif [[ $file == *"2.Í∞úÎ≥ÑÏ¢ÖÎ™©"* ]]; then
              TITLE="üîç Í∞úÎ≥ÑÏ¢ÖÎ™© Î∂ÑÏÑù: $filename"
              EMOJI="üìä"
              CATEGORY="Ï¢ÖÎ™©Î∂ÑÏÑù"
            elif [[ $file == *"1.Study"* ]]; then
              TITLE="üè≠ ÏÇ∞ÏóÖ Î∂ÑÏÑù: $filename"
              EMOJI="‚ö°"
              CATEGORY="ÏÇ∞ÏóÖÎ∂ÑÏÑù"
            else
              TITLE="üìù ÏÉà Í∏Ä ÏóÖÎç∞Ïù¥Ìä∏: $filename"
              EMOJI="üìÑ"
              CATEGORY="Í∏∞ÌÉÄ"
            fi
            
            CONTENT_TITLE=""
            if [[ -f "$file" ]]; then
              CONTENT_TITLE=$(head -20 "$file" | grep -E "^# " | head -1 | sed 's/^# //' | sed 's/üìä //g' | sed 's/üîç //g' | sed 's/üè≠ //g' || echo "")
            fi
            
            CONTENT_SUMMARY=""
            if [[ -f "$file" ]]; then
              CONTENT_SUMMARY=$(head -15 "$file" | grep -v "^#" | grep -v "^---" | grep -v "^$" | head -3 | tr '\n' ' ' | sed 's/\*\*//g' | sed 's/\*//g' | cut -c1-200)
            fi
            
            echo "{" > /tmp/telegram_message.json
            echo "  \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\"," >> /tmp/telegram_message.json
            echo -n "  \"text\": \"$EMOJI $TITLE\\n\\nüîó moneydiary.co.kr\\n\\nüìã Ïπ¥ÌÖåÍ≥†Î¶¨: $CATEGORY" >> /tmp/telegram_message.json
            
            if [[ -n "$CONTENT_TITLE" ]]; then
              echo -n "\\n\\nüìå ÏõêÎ¨∏ Ï†úÎ™©: $CONTENT_TITLE" >> /tmp/telegram_message.json
            fi
            
            if [[ -n "$CONTENT_SUMMARY" ]]; then
              echo -n "\\n\\nüí≠ ÎÇ¥Ïö© ÏöîÏïΩ:\\n${CONTENT_SUMMARY}..." >> /tmp/telegram_message.json
            fi
            
            echo -n "\\n\\n‚è∞ ÏóÖÎç∞Ïù¥Ìä∏: $(date '+%Y-%m-%d %H:%M:%S')\"," >> /tmp/telegram_message.json
            echo "  \"parse_mode\": \"HTML\"," >> /tmp/telegram_message.json
            echo "  \"disable_web_page_preview\": false" >> /tmp/telegram_message.json
            echo "}" >> /tmp/telegram_message.json
            
            if [[ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]] || [[ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]]; then
              echo "Error: Telegram bot token or chat ID not set"
              continue
            fi
            
            response=$(curl -s -w "%{http_code}" -X POST \
              "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -H "Content-Type: application/json" \
              -d @/tmp/telegram_message.json)
            
            http_code="${response: -3}"
            
            if [[ "$http_code" == "200" ]]; then
              echo "‚úÖ Message sent successfully for: $file"
            else
              echo "‚ùå Failed to send message for: $file (HTTP: $http_code)"
              echo "Response: $response"
            fi
            
            rm -f /tmp/telegram_message.json
            sleep 2
            
          fi
        done
