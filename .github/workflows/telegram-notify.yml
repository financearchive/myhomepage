name: Smart Telegram Notification (Debug)

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'src/site/notes/**'

jobs:
  notify:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v39
      with:
        files: |
          src/site/notes/**

    - name: Debug changed files
      run: |
        echo "ğŸ“‚ ê°ì§€ëœ íŒŒì¼ ëª©ë¡:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"

    - name: Process and send notification
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
          echo "âŒ Error: Telegram bot token or chat ID not set"
          exit 1
        fi

        CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"

        for file in $CHANGED_FILES; do
          echo "ğŸ” ì²˜ë¦¬ ì¤‘: $file"

          if [[ $file == *.md ]]; then

            if [[ $file == *"Home.md"* ]]; then
              echo "â© Home.md ê°ì§€ë¨ - ìŠ¤í‚µ"
              continue
            fi

            FULL_PATH="./$file"

            if [[ ! -f "$FULL_PATH" ]]; then
              echo "âš ï¸ íŒŒì¼ ì—†ìŒ: $FULL_PATH"
              continue
            fi

            filename=$(basename "$file" .md)

            # ì¹´í…Œê³ ë¦¬ êµ¬ë¶„
            if [[ $file == *"0.DAILY Invest"* ]]; then
              TITLE="ğŸ“Š ì˜¤ëŠ˜ì˜ ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ ì‹œí™©($filename)"
              EMOJI="ğŸ“ˆ"
              CATEGORY="ì‹œí™©ë¶„ì„"
            elif [[ $file == *"2.ê°œë³„ì¢…ëª©"* ]]; then
              TITLE="ğŸ” ê°œë³„ì¢…ëª© ë¶„ì„: $filename"
              EMOJI="ğŸ“Š"
              CATEGORY="ì¢…ëª©ë¶„ì„"
            elif [[ $file == *"1.Study"* ]]; then
              TITLE="ğŸ­ ì‚°ì—… ë¶„ì„: $filename"
              EMOJI="âš¡"
              CATEGORY="ì‚°ì—…ë¶„ì„"
            else
              TITLE="ğŸ“ ìƒˆ ê¸€ ì—…ë°ì´íŠ¸: $filename"
              EMOJI="ğŸ“„"
              CATEGORY="ê¸°íƒ€"
            fi

            # ì œëª© ì¶”ì¶œ
            CONTENT_TITLE=$(head -20 "$FULL_PATH" | grep -E "^# " | head -1 | sed 's/^# //' | sed 's/ğŸ“Š //g' | sed 's/ğŸ” //g' | sed 's/ğŸ­ //g' || echo "")

            # ìš”ì•½ ì¶”ì¶œ
            CONTENT_SUMMARY=$(head -15 "$FULL_PATH" | grep -v "^#" | grep -v "^---" | grep -v "^$" | head -3 | tr '\n' ' ' | sed 's/\*\*//g' | sed 's/\*//g' | cut -c1-200)

            # ë©”ì‹œì§€ ì‘ì„±
            MESSAGE="$EMOJI <b>$TITLE</b><br><br>"
            MESSAGE+="ğŸ”— <a href=\"https://www.moneydiary.co.kr\">moneydiary.co.kr</a><br><br>"
            MESSAGE+="ğŸ“‹ ì¹´í…Œê³ ë¦¬: $CATEGORY"

            if [[ -n "$CONTENT_TITLE" ]]; then
              MESSAGE+="<br><br>ğŸ“Œ ì›ë¬¸ ì œëª©: $CONTENT_TITLE"
            fi

            if [[ -n "$CONTENT_SUMMARY" ]]; then
              MESSAGE+="<br><br>ğŸ’­ ë‚´ìš© ìš”ì•½:<br>${CONTENT_SUMMARY}..."
            fi

            MESSAGE+="<br><br>â° ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S')"

            echo "ğŸš€ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì¤€ë¹„"

            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "$(jq -nc --arg chat_id "$TELEGRAM_CHAT_ID" \
                           --arg text "$MESSAGE" \
                           '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')"

            echo "âœ… í…”ë ˆê·¸ë¨ ì „ì†¡ ì™„ë£Œ: $file"

            sleep 2

          else
            echo "â„¹ï¸ md íŒŒì¼ì´ ì•„ë‹˜ - ìŠ¤í‚µ: $file"
          fi
        done
