name: Smart Telegram Notification (UTF-8 + ì•ˆì „ ì¸ì½”ë”© ì™„ì „ë²„ì „)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/site/notes/**'

jobs:
  notify:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Get changed files and send notification
      run: |
        # UTF-8 í™˜ê²½ ì„¤ì •
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        
        # Git ì„¤ì •
        git config --global core.quotepath false
        git config --global core.precomposeunicode true
        
        echo "ğŸ“‚ ë³€ê²½ íŒŒì¼ ì¶”ì¶œ ì¤‘..."
        
        # í† í° í™•ì¸
        if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
          echo "âŒ Error: Telegram bot token or chat ID not set"
          exit 1
        fi
        
        # ë³€ê²½ëœ íŒŒì¼ë“¤ ê°€ì ¸ì˜¤ê¸°
        changed_files=$(git diff --name-only HEAD~1 HEAD -- 'src/site/notes/**/*.md' | grep -v "Home.md" || true)
        
        if [[ -z "$changed_files" ]]; then
          echo "â„¹ï¸ ë³€ê²½ëœ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 0
        fi
        
        echo "ğŸ” ê°ì§€ëœ íŒŒì¼ë“¤:"
        echo "$changed_files"
        
        # ê° íŒŒì¼ ì²˜ë¦¬
        echo "$changed_files" | while IFS= read -r file; do
          if [[ -z "$file" ]]; then
            continue
          fi
          
          echo "ğŸ“„ ì²˜ë¦¬ ì¤‘: $file"
          
          # íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [[ ! -f "$file" ]]; then
            echo "âš ï¸ íŒŒì¼ ì—†ìŒ: $file"
            continue
          fi
          
          # íŒŒì¼ëª… ì¶”ì¶œ
          filename=$(basename "$file" .md)
          
          # ì¹´í…Œê³ ë¦¬ êµ¬ë¶„
          if [[ $file == *"0.DAILY Invest"* ]]; then
            TITLE="ğŸ“Š ì˜¤ëŠ˜ì˜ ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ ì‹œí™©($filename)"
            EMOJI="ğŸ“ˆ"
            CATEGORY="ì‹œí™©ë¶„ì„"
          elif [[ $file == *"2.ê°œë³„ì¢…ëª©"* ]]; then
            TITLE="ğŸ” ê°œë³„ì¢…ëª© ë¶„ì„: $filename"
            EMOJI="ğŸ“Š"
            CATEGORY="ì¢…ëª©ë¶„ì„"
          elif [[ $file == *"1.Study"* ]]; then
            TITLE="ğŸ­ ì‚°ì—… ë¶„ì„: $filename"
            EMOJI="âš¡"
            CATEGORY="ì‚°ì—…ë¶„ì„"
          else
            TITLE="ğŸ“ ìƒˆ ê¸€ ì—…ë°ì´íŠ¸: $filename"
            EMOJI="ğŸ“„"
            CATEGORY="ê¸°íƒ€"
          fi
          
          # ë‚´ìš© ì¶”ì¶œ
          CONTENT_TITLE=$(head -20 "$file" | grep -E "^# " | head -1 | sed 's/^# //' | sed 's/ğŸ“Š //g' | sed 's/ğŸ” //g' | sed 's/ğŸ­ //g' || echo "")
          CONTENT_SUMMARY=$(head -15 "$file" | grep -v "^#" | grep -v "^---" | grep -v "^$" | head -3 | tr '\n' ' ' | sed 's/\*\*//g' | sed 's/\*//g' | cut -c1-200)
          
          # ë©”ì‹œì§€ êµ¬ì„±
          MESSAGE="$EMOJI <b>$TITLE</b>\n\nğŸ”— <a href=\"https://moneydiary.co.kr\">moneydiary.co.kr</a>\n\nğŸ“‹ <b>ì¹´í…Œê³ ë¦¬</b>: $CATEGORY"
          
          if [[ -n "$CONTENT_TITLE" ]]; then
            MESSAGE="$MESSAGE\n\nğŸ“Œ <b>ì›ë¬¸ ì œëª©</b>: $CONTENT_TITLE"
          fi
          
          if [[ -n "$CONTENT_SUMMARY" ]]; then
            MESSAGE="$MESSAGE\n\nğŸ’­ <b>ë‚´ìš© ìš”ì•½</b>:\n$CONTENT_SUMMARY..."
          fi
          
          MESSAGE="$MESSAGE\n\nâ° <i>ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S')</i>"
          
          # í…”ë ˆê·¸ë¨ ì „ì†¡ìš© JSON íŒŒì¼ ìƒì„±
          cat > /tmp/message.json << 'EOF'
{
  "chat_id": "CHAT_ID_PLACEHOLDER",
  "text": "MESSAGE_PLACEHOLDER",
  "parse_mode": "HTML",
  "disable_web_page_preview": false
}
EOF

          # CHAT_ID êµì²´
          sed -i "s/CHAT_ID_PLACEHOLDER/$TELEGRAM_CHAT_ID/g" /tmp/message.json
          
          # ë©”ì‹œì§€ ë‚´ìš©ì„ JSON ì•ˆì „í•˜ê²Œ ì¸ì½”ë”©
          MESSAGE_ENCODED=$(python3 -c <<EOF
import sys, json
message = sys.stdin.read()
print(json.dumps(message)[1:-1])
EOF
          ) <<< "$(echo -e "$MESSAGE")"
          
          # MESSAGE_PLACEHOLDER êµì²´
          sed -i "s/MESSAGE_PLACEHOLDER/$MESSAGE_ENCODED/g" /tmp/message.json
          
          # í…”ë ˆê·¸ë¨ ì „ì†¡
          response=$(curl -s -w "%{http_code}" -X POST \
            "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d @/tmp/message.json)
          
          http_code="${response: -3}"
          
          if [[ "$http_code" == "200" ]]; then
            echo "âœ… í…”ë ˆê·¸ë¨ ì „ì†¡ ì„±ê³µ: $file"
          else
            echo "âŒ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨: $file (HTTP: $http_code)"
            echo "Response: ${response%???}"
          fi
          
          rm -f /tmp/message.json
          sleep 2
        done
