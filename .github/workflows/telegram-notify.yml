name: Smart Telegram Notification

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'src/site/notes/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v39
      with:
        files: |
          src/site/notes/**

    - name: Process and send notification
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        # ë³€ê²½ëœ íŒŒì¼ë“¤ ì²˜ë¦¬
        CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        for file in $CHANGED_FILES; do
          if [[ $file == *.md ]]; then
            echo "Processing file: $file"
            
            # Home.md íŒŒì¼ì€ ì œì™¸
            if [[ $file == *"Home.md"* ]]; then
              echo "Skipping Home.md file"
              continue
            fi
            
            # íŒŒì¼ì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
            if [[ ! -f "$file" ]]; then
              echo "File not found: $file"
              continue
            fi
            
            # íŒŒì¼ ì´ë¦„ ì¶”ì¶œ (í™•ìž¥ìž ì œê±°)
            filename=$(basename "$file" .md)
            
            # í´ë” ê²½ë¡œë¡œ ì¹´í…Œê³ ë¦¬ íŒë‹¨
            if [[ $file == *"0.DAILY Invest"* ]]; then
              TITLE="ðŸ“Š ì˜¤ëŠ˜ì˜ ë¯¸êµ­ ì£¼ì‹ ì‹œìž¥ ì‹œí™©($filename)"
              EMOJI="ðŸ“ˆ"
              CATEGORY="ì‹œí™©ë¶„ì„"
              
            elif [[ $file == *"2.ê°œë³„ì¢…ëª©"* ]]; then
              TITLE="ðŸ” ê°œë³„ì¢…ëª© ë¶„ì„: $filename"
              EMOJI="ðŸ“Š"
              CATEGORY="ì¢…ëª©ë¶„ì„"
              
            elif [[ $file == *"1.Study"* ]]; then
              TITLE="ðŸ­ ì‚°ì—… ë¶„ì„: $filename"
              EMOJI="âš¡"
              CATEGORY="ì‚°ì—…ë¶„ì„"
              
            else
              TITLE="ðŸ“ ìƒˆ ê¸€ ì—…ë°ì´íŠ¸: $filename"
              EMOJI="ðŸ“„"
              CATEGORY="ê¸°íƒ€"
            fi
            
            # íŒŒì¼ ë‚´ìš©ì—ì„œ ì‹¤ì œ ì œëª© ì¶”ì¶œ
            CONTENT_TITLE=""
            if [[ -f "$file" ]]; then
              CONTENT_TITLE=$(head -20 "$file" | grep -E "^# " | head -1 | sed 's/^# //' | sed 's/ðŸ“Š //g' | sed 's/ðŸ” //g' | sed 's/ðŸ­ //g' || echo "")
            fi
            
            # íŒŒì¼ ë‚´ìš© ìš”ì•½
            CONTENT_SUMMARY=""
            if [[ -f "$file" ]]; then
              CONTENT_SUMMARY=$(head -15 "$file" | grep -v "^#" | grep -v "^---" | grep -v "^$" | head -3 | tr '\n' ' ' | sed 's/\*\*//g' | sed 's/\*//g' | cut -c1-200)
            fi
            
            # ë©”ì‹œì§€ êµ¬ì„±
            MESSAGE="$EMOJI $TITLE

ðŸ”— moneydiary.co.kr

ðŸ“‹ ì¹´í…Œê³ ë¦¬: $CATEGORY"
            
            # ì‹¤ì œ ì œëª©ì´ ìžˆìœ¼ë©´ ì¶”ê°€
            if [[ -n "$CONTENT_TITLE" ]]; then
              MESSAGE="$MESSAGE

ðŸ“Œ ì›ë¬¸ ì œëª©: $CONTENT_TITLE"
            fi
            
            # ìš”ì•½ ë‚´ìš© ì¶”ê°€
            if [[ -n "$CONTENT_SUMMARY" ]]; then
              MESSAGE="$MESSAGE

ðŸ’­ ë‚´ìš© ìš”ì•½: 
${CONTENT_SUMMARY}..."
            fi
            
            MESSAGE="$MESSAGE

â° ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S')"
            
            # í…”ë ˆê·¸ëž¨ ë´‡ í† í°ê³¼ ì±„íŒ… ID í™•ì¸
            if [[ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]] || [[ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]]; then
              echo "Error: Telegram bot token or chat ID not set"
              continue
            fi
            
            # í…”ë ˆê·¸ëž¨ìœ¼ë¡œ ì „ì†¡ (íŒŒì¼ë¡œ ìž„ì‹œ ì €ìž¥ í›„ ì „ì†¡)
            cat > /tmp/telegram_message.json << EOF
{
  "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
  "text": "$MESSAGE",
  "parse_mode": "HTML",
  "disable_web_page_preview": false
}
EOF
            
            # curlë¡œ ì „ì†¡
            response=$(curl -s -w "%{http_code}" -X POST \
              "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -H "Content-Type: application/json" \
              -d @/tmp/telegram_message.json)
            
            http_code="${response: -3}"
            
            if [[ "$http_code" == "200" ]]; then
              echo "âœ… Message sent successfully for: $file"
            else
              echo "âŒ Failed to send message for: $file (HTTP: $http_code)"
              echo "Response: $response"
            fi
            
            # ìž„ì‹œ íŒŒì¼ ì‚­ì œ
            rm -f /tmp/telegram_message.json
            
            # ê° íŒŒì¼ë§ˆë‹¤ 2ì´ˆ ëŒ€ê¸° (ì—°ì† ì „ì†¡ ë°©ì§€)
            sleep 2
            
          fi
        done
