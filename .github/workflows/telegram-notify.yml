name: Telegram Notify via git diff

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/site/notes/**'

jobs:
  notify:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0   # 모든 git 히스토리 가져오기

    - name: Get changed files via git diff
      id: get-diff
      run: |
        echo "📂 변경 파일 추출 중 (git diff 사용)"

        git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt

        cat changed_files.txt

        echo "changed_files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_ENV

    - name: Process and send notification
      run: |
        if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
          echo "❌ Error: Telegram bot token or chat ID not set"
          exit 1
        fi

        for file in ${{ env.changed_files }}; do
          echo "🔍 감지된 파일: $file"

          if [[ "$file" == src/site/notes/*.md || "$file" == src/site/notes/**/*.md ]]; then

            if [[ $file == *"Home.md"* ]]; then
              echo "⏩ Home.md 감지됨 - 스킵"
              continue
            fi

            FULL_PATH="./$file"

            if [[ ! -f "$FULL_PATH" ]]; then
              echo "⚠️ 파일 없음: $FULL_PATH"
              continue
            fi

            filename=$(basename "$file" .md)

            # 카테고리 구분
            if [[ $file == *"0.DAILY Invest"* ]]; then
              TITLE="📊 오늘의 미국 주식 시장 시황($filename)"
              EMOJI="📈"
              CATEGORY="시황분석"
            elif [[ $file == *"2.개별종목"* ]]; then
              TITLE="🔍 개별종목 분석: $filename"
              EMOJI="📊"
              CATEGORY="종목분석"
            elif [[ $file == *"1.Study"* ]]; then
              TITLE="🏭 산업 분석: $filename"
              EMOJI="⚡"
              CATEGORY="산업분석"
            else
              TITLE="📝 새 글 업데이트: $filename"
              EMOJI="📄"
              CATEGORY="기타"
            fi

            CONTENT_TITLE=$(head -20 "$FULL_PATH" | grep -E "^# " | head -1 | sed 's/^# //' | sed 's/📊 //g' | sed 's/🔍 //g' | sed 's/🏭 //g' || echo "")
            CONTENT_SUMMARY=$(head -15 "$FULL_PATH" | grep -v "^#" | grep -v "^---" | grep -v "^$" | head -3 | tr '\n' ' ' | sed 's/\*\*//g' | sed 's/\*//g' | cut -c1-200)

            MESSAGE="$EMOJI <b>$TITLE</b><br><br>"
            MESSAGE+="🔗 <a href=\"https://www.moneydiary.co.kr\">moneydiary.co.kr</a><br><br>"
            MESSAGE+="📋 카테고리: $CATEGORY"

            if [[ -n "$CONTENT_TITLE" ]]; then
              MESSAGE+="<br><br>📌 원문 제목: $CONTENT_TITLE"
            fi

            if [[ -n "$CONTENT_SUMMARY" ]]; then
              MESSAGE+="<br><br>💭 내용 요약:<br>${CONTENT_SUMMARY}..."
            fi

            MESSAGE+="<br><br>⏰ 업데이트: $(date '+%Y-%m-%d %H:%M:%S')"

            echo "🚀 텔레그램 메시지 전송 준비"

            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "$(jq -nc --arg chat_id "$TELEGRAM_CHAT_ID" \
                           --arg text "$MESSAGE" \
                           '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')"

            echo "✅ 텔레그램 전송 완료: $file"

            sleep 2

          else
            echo "ℹ️ md 파일 아님 - 스킵: $file"
          fi
        done
